<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>Grammar of Graphics | Data Visualization in R</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.1.1">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    <link rel="next" href="../visualize/interactive.html" />
    
    
    <link rel="prev" href="../visualize/summarize.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">

    
    <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-quizzes/quizzes.css">
    


        
    <div class="book" data-level="1.3" data-basepath=".." data-revision="1414860571627">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="visualize/README.html">
            
                
                    <a href="../visualize/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         Data Visualization
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1" data-path="visualize/base_graphics.html">
            
                
                    <a href="../visualize/base_graphics.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                         Base Graphics
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2" data-path="visualize/summarize.html">
            
                
                    <a href="../visualize/summarize.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                         Intro to ggplot2
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="1.3" data-path="visualize/ggplot2.html">
            
                
                    <a href="../visualize/ggplot2.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                         Grammar of Graphics
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.4" data-path="visualize/interactive.html">
            
                
                    <a href="../visualize/interactive.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                         Interactive Graphics
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Data Visualization in R</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_3">
                    
                        <h1 id="grammar-of-graphics">Grammar of Graphics</h1>
<p>In this lesson, you will learn about the grammar of graphics, and how its implementation in the <code>ggplot2</code> package provides you with the flexibility to create a wide variety of sophisticated visualizations with little code.</p>
<p>We have used <code>ggplot2</code> before when we were analyzing the  <code>bnames</code> data. Just to recap, let me create a simple scatterplot plot of <code>tip</code> vs <code>total_bill</code> from the dataset <code>tips</code> found in the <code>reshape2</code> package</p>
<pre><code class="lang-r">data(tips, package = <span class="hljs-string">'reshape2'</span>)
<span class="hljs-keyword">library</span>(ggplot2)
qplot(total_bill, tip, data = tips, geom = <span class="hljs-string">"point"</span>)
</code></pre>
<p><img src="figure/uempmed1-1.png" title="plot of chunk uempmed1" alt="plot of chunk uempmed1" style="display: block; margin: auto;" /></p>
<p>The <code>qplot</code> function pretty much works like a drop-in-replacement for the <code>plot</code> function in base R. But using it just as a replacement is gross injustice to <code>ggplot2</code> which is capable of doing so much more. </p>
<p>So if there is one advice I could give you about learning <code>ggplot2</code>, it would be to stop reading examples using <code>qplot</code> because it gives you the false impression that you have mastered the grammar, when in fact you have not. <code>qplot</code> provides some nice syntactic sugar, but is not the real deal.</p>
<p>So, what is the <strong>grammar of graphics</strong>? Rather than describing the theory behind the grammar, let me explain it by deconstructing the plot you see below.</p>
<p><img src="figure/unnamed-chunk-1-1.png" title="plot of chunk unnamed-chunk-1" alt="plot of chunk unnamed-chunk-1" style="display: block; margin: auto;" /></p>
<p>I want to focus your attention on two sets of elements in this plot</p>
<p><strong>Aesthetics</strong></p>
<p>First, let us focus on the variables <code>tip</code>, <code>total_bill</code> and <code>sex</code>. You can see from the plot that we have mapped <code>total_bill</code> to <code>x</code>, <code>tip</code> to <code>y</code> and the color of the point to <code>sex</code>. These graphical properties <code>x</code>, <code>y</code> and <code>sex</code> that encode the data on the plot are referred to as <code>aesthetics</code>. Some other aesthetics to consider are <code>size</code>, <code>shape</code> etc.</p>
<p><strong>Geometries</strong></p>
<p>The second element to focus on are the visual elements you can see in the plot itself. I see three distinct visual elements in this plot.</p>
<ul>
<li>point</li>
<li>line</li>
<li>ribbon</li>
</ul>
<p>These actual graphical elements displayed in a plot are referred to as <code>geometries</code>. Some other <code>geometries</code> you might be familiar with are <code>area</code>, <code>bar</code>, <code>text</code>.</p>
<p>Another very useful way of thinking about this plot is in terms of <code>layers</code>. You can think of a <code>layer</code> as consisting of <code>data</code>, a <code>mapping</code> of <code>aesthetics</code>, a <code>geometry</code> to visually display, and sometimes additional parameters to customize the display.</p>
<p>There are three layers in this plot. A <code>point</code> layer, a <code>line</code> layer and a <code>ribbon</code> layer. Let us start by defining the first layer, <code>point_layer</code>. <code>ggplot2</code> allows you to translate the <code>layer</code> exactly as you see it in terms of the constituent elements. The syntax being used might seem very verbose when compared to <code>qplot</code>, but I recommend some patience, since the rewards you reap by understanding the grammar are worth the trouble.</p>
<pre><code class="lang-r">layer_point &lt;- geom_point(
  mapping = aes(x = total_bill, y = tip, color = sex),
  data = tips,
  size = <span class="hljs-number">3</span>
)
ggplot() + layer_point
</code></pre>
<p><img src="figure/layer1-1.png" title="plot of chunk layer1" alt="plot of chunk layer1" style="display: block; margin: auto;" /></p>
<p>That was easy! Wasn&#39;t it? Let us move on to the second layer. It is a regression line fitted through the points. We know that the <code>x</code> is still mapped to <code>total_bill</code>, but we have to map the <code>y</code> to a fitted value of <code>tip</code> rather than <code>tip</code>. How do we get the fitted value? </p>
<p>Well, we can use <code>lm</code> followed by <code>predict</code> to compute not only the fitted values, but also a confidence interval around the fitted values which will come in handy later. Note that we combine the <code>total_bill</code> column with the predicted estimates so that we can keep the <code>x</code> and <code>y</code> values in sync.</p>
<pre><code class="lang-r">model &lt;- lm(tip ~ total_bill, data = tips)
fitted_tips &lt;- data.frame(
  total_bill = tips$total_bill, 
  predict(model, interval = <span class="hljs-string">"confidence"</span>)
)
head(fitted_tips)
</code></pre>
<pre><code>##   total_bill      fit      lwr      upr
## 1      16.99 2.704636 2.569519 2.839753
## 2      10.34 2.006223 1.818101 2.194345
## 3      21.01 3.126835 2.996732 3.256937
## 4      23.68 3.407250 3.266528 3.547972
## 5      24.59 3.502822 3.356301 3.649344
## 6      25.29 3.576340 3.424725 3.727955
</code></pre><p>Now it is time to define our second layer, since we have the data required to do so.</p>
<pre><code class="lang-r">layer_line &lt;- geom_line(
  mapping = aes(x = total_bill, y = fit),
  data = fitted_tips,
  color = <span class="hljs-string">"darkred"</span>
)
ggplot() + layer_point + layer_line
</code></pre>
<p><img src="figure/layer2-1.png" title="plot of chunk layer2" alt="plot of chunk layer2" style="display: block; margin: auto;" /></p>
<p>That was fun right! Now, let me see if you have been able to grasp the idea of the grammar. How would you go about adding the ribbon layer that adds a confidence interval around the line? What about if you were asked to add a prediction interval?</p>
<p><strong>Exercise 1</strong></p>
<p>Let me give you a hint. You need to use a <code>ribbon</code> geometry, which requires two values of <code>y</code> corresponding to the lower and upper limits of the interval. You can type <code>?geom_ribbon</code> to see the names of these <code>aesthetics</code> so that you can provide them correctly in the <code>mapping</code> argument.</p>
<p><strong>Solution 1</strong></p>
<pre><code class="lang-r">layer_ribbon &lt;- geom_ribbon(
  mapping = aes(x = total_bill, ymin = lwr, ymax = upr, y = <span class="hljs-literal">NULL</span>),
  data = fitted_tips,
  alpha = <span class="hljs-number">0.3</span>
)
ggplot() + layer_point + layer_line + layer_ribbon
</code></pre>
<p><img src="figure/layer3-1.png" title="plot of chunk layer3" alt="plot of chunk layer3" style="display: block; margin: auto;" /></p>
<p>While the approach we took to create this plot was very logical and followed the grammar, it is still verbose, especially since such plots are very common in statistical applications. So is there a way to make this simpler?</p>
<p>Fortunately, both the grammar of graphics and its implementation in <code>ggplot2</code> are flexible enought to define <code>statistical</code> transformations on the data in a layer. In <code>ggplot2</code>, there is <code>stat = smooth</code>, which accepts a smoothing method as input, and automatically does the statistical transformations in the background. So, we can define the combined line and ribbon layers as</p>
<pre><code class="lang-r">layer_smooth &lt;- geom_smooth(
  mapping = aes(x = total_bill, y = tip),
  data = tips,
  stat = <span class="hljs-string">"smooth"</span>,
  method = <span class="hljs-string">"lm"</span>
)
ggplot() + layer_point + layer_smooth
</code></pre>
<p><img src="figure/layer4-1.png" title="plot of chunk layer4" alt="plot of chunk layer4" style="display: block; margin: auto;" /></p>
<p>That was better wasn&#39;t it. But wait a minute, there is still a lot of repetition in this code, and repetition is never good. The <code>x</code> and <code>y</code> aesthetics in <code>mapping</code> and the <code>data</code> argument are common to both <code>layer_point</code> and <code>layer_smooth</code>. How do we remove this duplication?</p>
<p>All you need to do is to move the <code>data</code> and <code>mapping</code> definitions to the <code>ggplot</code> base layer and all other layers automatically inherit this information, if not specified explicitly. Once again kudos to Hadley for thinking throught this.</p>
<pre><code class="lang-r">ggplot(tips, aes(x = total_bill, y = tip)) +
  geom_point(aes(color = sex)) +
  geom_smooth(method = <span class="hljs-string">'lm'</span>)
</code></pre>
<p><img src="figure/layer5-1.png" title="plot of chunk layer5" alt="plot of chunk layer5" style="display: block; margin: auto;" /></p>
<p>Question: What would happen if you moved the <code>color</code> aesthetic to the <code>ggplot</code> layer? Reason it out before proceeding to running the code.</p>
<p><a href="javascript:expandcollapse('solution1')">
   [+/-] Solution
</a><br></p>
<p><span class='posthidden' id='solution1'>
The <code>smooth</code> layer will inherit the <code>color</code> aesthetic as well as a result of which you will see two regression lines fitted, one for each sex.
</span></p>
<p><strong>Exercise 2</strong></p>
<p>You will replicate the following plot shown below. You will need to use the datasets <code>economics</code> and <code>presidential</code> from <code>ggplot2</code>.</p>
<p><img src="figure/econ-presidential-1.png" title="plot of chunk econ-presidential" alt="plot of chunk econ-presidential" style="display: block; margin: auto;" /></p>
<h2 id="faceting">Faceting</h2>
<p>When dealing with multivariate data, we often want to display plots for specific subsets of data, laid out in a panel. These plots are often referred to as small-multiple plots. They are very useful in practice since you only need to take your user through one of the plots in the panel, and leave them to interpret the others in terms of that.</p>
<p><code>ggplot2</code> supports small-multiple plots using the idea of <code>facets</code>. Let us revisit our scatterplot of <code>total_bill</code> vs <code>tip</code>. We can facet it by the variable <code>day</code> using <code>facet_wrap</code>.</p>
<pre><code class="lang-r">ggplot() +
  layer_point +
  layer_smooth +
  facet_wrap(~ day)
</code></pre>
<p><img src="figure/facet-wrap-1.png" title="plot of chunk facet-wrap" alt="plot of chunk facet-wrap" style="display: block; margin: auto;" /></p>
<p>Note how <code>ggplot2</code> automatically split the data into four subsets and even fitted the regression lines by panel. The power of a grammar based approach shines through best in such situations.</p>
<p>We can also facet across two variables using <code>facet_grid</code></p>
<pre><code class="lang-r">ggplot() +
  layer_point +
  layer_smooth +
  facet_grid(smoker ~ day)
</code></pre>
<p><img src="figure/facet-grid-1.png" title="plot of chunk facet-grid" alt="plot of chunk facet-grid" style="display: block; margin: auto;" /></p>
<script>
function expandcollapse (postid) { 
  whichpost = document.getElementById(postid); 
  if (whichpost.className=="postshown") { 
    whichpost.className="posthidden"; 
  } 
  else { 
    whichpost.className="postshown"; 
  } 
} 
</script>

<style type="text/css" media="screen">
.posthidden {display:none}
.postshown {display:inline}
</style>


                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../visualize/summarize.html" class="navigation navigation-prev " aria-label="Previous page: Intro to ggplot2"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../visualize/interactive.html" class="navigation navigation-next " aria-label="Next page: Interactive Graphics"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-quizzes/quizzes.js"></script>
    

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":"white","family":"sans","size":1}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
